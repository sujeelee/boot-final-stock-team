<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorate="~{layout/layout.html}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
	<style type="text/css">
		body {
	        background-color: #f4f6f8;
	    }
	
	    .main_wrap {
	        flex-direction: column;
	        align-items: center;
	    }
	
	    .news-date {
	        width: 100%;
	        height: 65px;
	        background-color: #fff;
	        border: 1px solid #ddd;
	        border-radius: 15px 15px 0 0;
	        padding: 17px 0 15px;
	        font-size: 1.2rem;
	        display: flex;
	        align-items: center;
	        justify-content: center;
	    }
	    
	    .explanatory-text{
	    	width: 100%;
	        height: 65px;
	        background-color: #fff;
	        border: 1px solid #ddd;
	        border-radius: 0 0 15px 15px;
	        border-top-style: none;
			padding: 15px;
	        margin-bottom: 20px;
	        color: #777;
	    }
	
	    .date-btn {
	        background-color: #fff;
	        border: none;
	        padding: 8px 8px 8px 12px;
	    }
	
	    #selected-date {
	        margin: 0 16px;
	        font-size: 19px;
	        font-weight: bold;
	        color: #1e1e23;
	    }
	
	    .news-container {
	        width: 100%;
	    }
	    
	    .undata-box{
	    	width: 1110px;
	    	height: 340px;
	    	background-color: #fff;
	        border: 1px solid #ddd;
	        border-radius: 15px;
	    }
	    
	    .undata-box p{
	    	color: #777;
	    	text-align: center;
	    	padding: 140px;
	    	font-size: 20px;
	    }
	
	    /* 기본 2열 그리드 레이아웃 */
	    .news-list {
	        width: 1110px;
	        list-style: none;
	        padding: 0;
	        margin: 0 -14px -15px 0;
	        display: grid;
	        grid-template-columns: repeat(2, 1fr);
	        gap: 22px;
	    }
	
	    .news-box {
	        padding: 26px;
	    }
	
	    .news-item {
	        background-color: #fff;
	        border: 1px solid #ddd;
	        border-radius: 15px;
	        height: 220px;
	    }
	
	    .news-heading-box a {
	        font-weight: bold;
	        font-size: 19px;
	        color: black;
	        text-decoration: none;
	    }
	
	    .news-title a {
	        font-size: 15px;
	        color: black;
	        text-decoration: none;
	    }
	
	    .news-content a {
	        font-size: 16px;
	        color: #777;
	        text-decoration: none;
	    }
	
	    .news-heading-box {
	        padding: 16px 23px 0 0;
	    }
		
		.news-title a, 
		.news-content a {
		    display: -webkit-box;
		    -webkit-line-clamp: 2;
		    -webkit-box-orient: vertical;
		    overflow: hidden;
		    text-overflow: ellipsis;
		    white-space: normal;
		}
		
		.news-content-box {
		    display: flex; 					/* Flexbox로 레이아웃 설정 */
		    justify-content: space-between; /* 좌우 공간 나누기 */
		    align-items: stretch; 			/* 수직 중앙 정렬 */
		    padding: 12px 0 21px;
		    height: 110px; 					/* 고정 높이 설정 */
		}
		
		.news-text-box{
			width: 300px;
		}
		
		.news-text-box.no-image {
		    width: auto; /* 이미지가 없을 때 적용할 스타일 */
		}
		
		.news-image-box {
		    flex-basis: 30%; 			/* 이미지 영역 크기 조정 */
		    max-width: 30%; 			/* 최대 넓이 설정 */
		    padding-left: 20px; 		/* 텍스트와 이미지 사이 간격 */
		    display: flex; 				/* Flexbox로 이미지 박스 레이아웃 설정 */
		    align-items: center; 		/* 세로 중앙 정렬 */
		    justify-content: center; 	/* 가로 중앙 정렬 */
		}
		
		.news-image-box img {
		    max-width: 100%;	 /* 이미지 크기 조정 */
		    height: 126px; 		 /* 비율에 맞게 조정 */
		    display: block;
		}

	
	    @media (max-width: 1200px) {
		    
	        .news-list {
	            width: 100%;
	            grid-template-columns: 1fr;
	        }
	
	        .news-item {
	            width: 100%;
	        }
	
	        .news-date {
	            width: 100%;
	        }
	        
	        .news-text-box{
				width: 580px;
			}
		
	    }
	</style>
</head>
<body>
	<main layout:fragment="content">
		
	    <div class="main_wrap mt-5">
	        <!-- 날짜 선택 버튼 영역 -->
	        <div class="news-date">
	            <button id="prev-date-btn" class="date-btn">◀</button>
	            <span id="selected-date"></span>
	            <button id="next-date-btn" class="date-btn">▶</button>
	        </div>
	        <div class="explanatory-text d-flex">
	            <span class="mr-auto" style="line-height: 30px;">뉴스를 누른 채 이동하면 순서 변경이 가능합니다.</span>
	            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown">
      				전체언론사
				</button>
				<div class="dropdown-menu">
					<h5 class="dropdown-header">언론사 홈 바로가기</h5>
					<a  class="dropdown-item" 
						th:each="item : ${list}" 
						th:href="@{/newspaper/newsList/{np_no}/{date}(np_no=${item.np_no},date=${ne_datetime})}" 
						th:text="${item.np_name}"></a>
				</div>
			</div>
	        <!-- 뉴스 리스트 박스 -->
	        <div class="news-container">
	            <ul class="news-list">
	                <li class="news-item">
	               		<div class="news-box">
		                    <div class="news-heading-box">
		                        <a href="#">신문사</a>
		                    </div>
		                    <div class="news-content-box">
		                    	<div class="news-text-box">
			                    	<div class="news-title mb-2">
			                    		<a href="#" style="font-size: 20px;">헤드라인 제목</a>
			                    	</div>
			                    	<div class="news-content">
				                        <a href="#">헤드라인 내용</a>                   		
			                    	</div>
		                    	</div>
		                    </div>
	                    </div>
	                </li>
	            </ul>
	        </div>
	    </div>
		
		<script th:inline="javascript">
			$(document).ready(function(){
				let today = new Date();
				let currentDate = new Date(today);
				$('#selected-date').text(formatDate(currentDate).substr(0,7));
				
				function formatDate(date){
					const year = date.getFullYear();
					const month = (date.getMonth() + 1).toString().padStart(2, '0');
					const day = date.getDate().toString().padStart(2, '0');
					const yyyy_mm_dd = year + "-" + month + "-" + day;
					return yyyy_mm_dd;
				} // 날짜를 문자열로 포맷팅
				
				$('#prev-date-btn').click(function(){
					currentDate.setMonth(currentDate.getMonth() - 1);
					update();
				}); // 이전 버튼 클릭 이벤트
				
				$('#next-date-btn').click(function(){
					currentDate.setMonth(currentDate.getMonth() + 1);
					update();
					
				}); // 다음 버튼 클릭 이벤트
				
				function buttonStatus(){
					if(formatDate(currentDate) == formatDate(today)){
						$('#next-date-btn').prop('disabled', true);
					}else{
						$('#next-date-btn').prop('disabled', false);
					}
				} // 현재 월을 넘어가지 못하게 하기위한 함수
				
				function update(){
					$('#selected-date').text(formatDate(currentDate).substr(0,7));
					fetchNews(currentDate);
					buttonStatus();
				} // 날짜, 기사, 버튼 활성화/비활성화를 업데이트 하는 함수
				
				function deleteTag(content) {
				    // HTML을 삭제하고 텍스트만 반환
				    return $('<div>').html(content).text();
				} // 디비에 있는 태그들을 제거하고 순수 텍스트만 가져오는 함수
				
				function fetchNews(date){
					let ne_datetime = formatDate(date);
					let news = {
						ne_datetime : ne_datetime
					}
					$.ajax({
						async : true, // 비동기 : true(비동기), false(동기)
						url : '/newspaper/views', 
						type : 'post', 
						data : JSON.stringify(news), 
						contentType : "application/json; charset=utf-8",
						dataType : "json", 
						success : function (data){
							displayNewsList(data.newsList);
						}, 
						error : function(jqXHR, textStatus, errorThrown){
							console.log(jqXHR);
						}
					});
				} // ajax 통신하여 기사를 가져오는 함수
				
				function displayNewsList(list){
					if(list == null || list.length == 0){
						let tmp = `
							<div class="undata-box">
								<p>발행된 종이 신문이 없거나<br>신문게재 정보가 입력되지 않았습니다.</p>
							</div>
						`;
						$('.news-container').html(tmp);
						return;
					}
					let str1 = '';
					let str2 = '';
					for(news of list){
						var ne_datetime = formatDate(new Date(news.ne_datetime));
						var ne_content = deleteTag(news.ne_content);
						str1 += `
							<li class="news-item" draggable="true">
			                	<div class="news-box">
				                    <div class="news-heading-box">
				                        <a href="/newspaper/newsList/${news.np_no}/${ne_datetime}">${news.np_name}</a>
				                    </div>
				                    <div class="news-content-box">
					                    <div class="news-text-box ${news.fi_path ? '' : 'no-image'}">
					                    	<div class="news-title">
					                    		<a href="/newspaper/detail/${news.ne_no}" style="font-size: 20px;">${news.ne_title}</a>
					                    	</div>
					                    	<div class="news-content">
						                        <a href="/newspaper/detail/${news.ne_no}">${ne_content}</a>                   		
					                    	</div>
					                    </div>
					                    ${news.fi_path ? `
				                            <div class="news-image-box">
				                                <img src="/uploads${news.fi_path}" alt="헤드라인 이미지">
				                            </div>
					                     ` : ''}
					                </div>
			                    </div>
			                </li>
						`;
					str2 = `
						<ul class="news-list">${str1}</ul>
					`;
		                
					}
					$('.news-container').html(str2);
					displayDrag();
				} // 서버에서 가져온 데이터로 html을 새로 생성하는 함수
				
				fetchNews(currentDate);
				buttonStatus();
				
				function displayDrag() {
				    const newsItems = $('.news-item');
				    let draggedItem = null;

				    newsItems.on('dragstart', function() {
				        draggedItem = $(this);
				        draggedItem.css('opacity', 0.5);
				    });

				    newsItems.on('dragend', function() {
				        draggedItem = null;
				        $(this).css('opacity', '');
				    });

				    newsItems.on('dragover', function(event) {
				        event.preventDefault();
				    });

				    newsItems.on('drop', function(event) {
				        event.preventDefault();
				        if (draggedItem) {
				            const list = $('.news-list');
				            const items = list.children();
				            const draggedIndex = items.index(draggedItem);
				            const dropIndex = items.index($(this));

				            if (draggedIndex < dropIndex) {
				                $(this).after(draggedItem);
				            } else {
				                $(this).before(draggedItem);
				            }
				        }
				    });
				}
			});
		</script>
	</main>
</body>
</html>