<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/layout.html}">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시드키 : 이벤트 : 룰렛</title>
    <style>
        .rouletter {
            position: relative;
            width: 400px;
            height: 400px;
            margin: auto;
            margin-top: 100px;
        }
        .rouletter-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px;
            height: 350px;
            border-radius: 350px;
            overflow: hidden;
        }
        .rouletter-wacu {
            width: 100%;
            height: 100%;
            background: #f5f5f2 no-repeat;
            background-size: 100%;
            transform-origin: center;
            transition-timing-function: ease-in-out;
            transition: 2s;
        }
        .rouletter-arrow {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 1px;
            border-right: 10px solid transparent;
            border-left: 10px solid transparent;
            border-top: 40px solid red;
            border-bottom: 0px solid transparent;
        }
        .rouletter-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 80px;
            background: #fff;
            border-image: linear-gradient(to right, #fbfcb9be, #ffcdf3aa, #65d3ffaa);
            border: 2px solid;
        }
        .hidden-input {
            display: none;
        }
    </style>
</head>

<body>
    <main layout:fragment="content">
        <div id="app"></div>

        <script th:inline="javascript">
            var rolLength = 0; // 룰렛 항목 갯수
            var setNum; // 랜덤으로 선택된 번호
            var hiddenInput = document.createElement("input");
            hiddenInput.className = "hidden-input";
            var products = []; // 상품 목록
            const ev_no = /*[[${ev_no}]]*/ '';

            // 랜덤숫자 생성 함수
            const rRandom = () => {
                var min = Math.ceil(0);
                var max = Math.floor(rolLength - 1);
                return Math.floor(Math.random() * (max - min)) + min;
            };

            // 룰렛 회전 함수
            const rRotate = () => {
                var panel = document.querySelector(".rouletter-wacu");
                var btn = document.querySelector(".rouletter-btn");
                var deg = [];
                
                // 룰렛 각도 설정
                for (var i = 1, len = rolLength; i <= len; i++) {
                    deg.push((360 / len) * i);
                }
                
                // 랜덤으로 선택된 번호를 히든 인풋에 저장
                var num = 0;
                document.body.append(hiddenInput);
                setNum = hiddenInput.value = rRandom();
                
                // 애니메이션 설정
                var ani = setInterval(() => {
                    num++;
                    panel.style.transform = "rotate(" + 360 * num + "deg)";
                    btn.disabled = true; // 버튼 비활성화
                    btn.style.pointerEvents = "none"; // 버튼 클릭 방지
                    
                    // 회전이 끝날 때, 마지막 위치로 조정
                    if (num === 50) {
                        clearInterval(ani);
                        panel.style.transform = `rotate(${deg[setNum]}deg)`;
                    }
                }, 50);
            };

            // 상품에 맞는 알림 팝업 표시
            const rLayerPopup = (num) => {
                var product = products[num];
                alert(`당첨!! ${product.name} (${product.pay}원)`);
            };

            // 버튼 클릭 후 초기화 함수
            const rReset = (ele) => {
                setTimeout(() => {
                    ele.disabled = false;
                    ele.style.pointerEvents = "auto";
                    rLayerPopup(setNum);
                    hiddenInput.remove();
                }, 5500);
            };

            // 룰렛을 초기화하는 함수
            const initializeRoulette = () => {
                // AJAX로 상품 목록을 받아옵니다
                $.ajax({
                    url: '/event/api/eventR_prize_insert', // EventController에서 상품 목록을 제공하는 URL
                    type: 'POST',
                    data: { ev_no: ev_no }, // 이벤트 번호 전송
                    success: function(data) {
                        products = data.products; // 서버에서 전달된 상품 데이터
                        rolLength = products.length; // 상품 개수
                        
                        // 룰렛 항목을 동적으로 생성
                        var panel = document.querySelector(".rouletter-wacu");
                        var itemDeg = 360 / rolLength;

                        for (var i = 0; i < rolLength; i++) {
                            var item = document.createElement("div");
                            item.className = "rouletter-item";
                            item.style.transform = `rotate(${itemDeg * i}deg)`;
                            item.innerHTML = `<span>${products[i].name}</span>`;
                            panel.appendChild(item);
                        }
                    }
                });
            };

            // 버튼 클릭 이벤트 처리
            $(document).on("click", ".rouletter-btn", function() {
                rRotate();
                rReset(this);
            });

            // 룰렛 기본 HTML 설정
            $("#app").html(`
                <div class="rouletter">
                    <div class="rouletter-bg">
                        <div class="rouletter-wacu"></div>
                    </div>
                    <div class="rouletter-arrow"></div>
                    <button class="rouletter-btn">start</button>
                </div>
            `);

            // 룰렛 초기화
            initializeRoulette();

        </script>
    </main>
</body>

</html>
