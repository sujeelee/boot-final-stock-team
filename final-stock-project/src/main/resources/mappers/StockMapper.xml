<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kh.st.boot.dao.StockDAO"> 

	<select id="getStockCompany" resultType="StockVO">
		select * from stock where st_code = #{st_code}
	</select>
	<update id="companyType">
		update stock 
		set st_type = #{st_type}
		<if test="st_status != null">
			, st_status = #{st_status} 
		</if>
		where st_code = #{st_code}
	</update>
	<insert id="insertStockCompany">
		insert into stock
		set st_code = #{st.st_code},
			st_name = #{st.st_name},
			st_qty = #{st.st_qty},
			st_board_cnt = 0,
			st_status = #{st.st_status},
			st_issue = #{st.st_issue},
			st_type = #{st.st_type}
	</insert>
	<select id="getCompanyList" resultType="StockVO">
		select * from stock where (1) 
		<if test="type != null">
			and st_status != #{type}
		</if>
		<if test="cri.st_type != null and cri.st_type.size() > 0 ">
			and st_type in
			<foreach collection="cri.st_type" item="items" open="(" close=")" separator=",">
				#{items}
			</foreach>
		</if>
		<if test="cri.stx != null and cri.stx != ''">
			<if test="cri.sfl == 'st_code'">
				and st_code LIKE CONCAT('%', #{cri.stx}, '%') 
			</if>
			<if test="cri.sfl == 'st_name'">
				and st_name LIKE CONCAT('%', #{cri.stx}, '%') 
			</if>
			<if test="cri.sfl == ''">
				and (st_name LIKE CONCAT('%', #{cri.stx}, '%') or st_code LIKE CONCAT('%', #{cri.stx}, '%') ) 
			</if>
		</if>
		<if test="cri.state != null and cri.state != ''">
			and st_status = #{cri.state}
		</if>
		order by st_name ASC
		<if test="cri != null">
			limit #{cri.pageStart}, #{cri.perPageNum}
		</if>
	</select>
	<select id="getStockPrice" resultType="StockPriceVO">
		select * from stock_info where si_date = #{si_date} and st_code = #{st_code}
	</select>
	<insert id="insertStockPrice" useGeneratedKeys="true" keyColumn="si.si_no">
		insert into stock_info
		set	si_date = #{si.si_date},
			si_price = #{si.si_price},
			st_code = #{si.st_code},
			si_vs = #{si.si_vs},
			si_fltRt = #{si.si_fltRt},
			si_mrkTotAmt = #{si.si_mrkTotAmt},
			si_hipr = #{si.si_hipr},
			si_lopr = #{si.si_lopr},
			si_trqu = #{si.si_trqu}
	</insert>
	<select id="getCount" resultType="int">
		select count(*) from stock where (1)
		<if test="cri.st_type != null and cri.st_type.size() > 0 ">
			and st_type in
			<foreach collection="cri.st_type" item="items" open="(" close=")" separator=",">
				#{items}
			</foreach>
		</if>
		<if test="cri.stx != null and cri.stx != ''">
			<if test="cri.sfl == 'st_code'">
				and st_code LIKE CONCAT('%', #{cri.stx}, '%') 
			</if>
			<if test="cri.sfl == 'st_name'">
				and st_name LIKE CONCAT('%', #{cri.stx}, '%') 
			</if>
			<if test="cri.sfl == ''">
				and (st_name LIKE CONCAT('%', #{cri.stx}, '%') or st_code LIKE CONCAT('%', #{cri.stx}, '%') ) 
			</if>
		</if>
		<if test="cri.state != null and cri.state != ''">
			and st_status = #{cri.state}
		</if>
	</select>
	<select id="getStockInfoList" resultType="StockPriceVO">
		select * from stock_info where st_code = #{st_code} order by si_date DESC
	</select>
	<select id="getCountStockPrice" resultType="int">
		select count(*) from stock_info where st_code = #{st_code}
	</select>
	<select id="getStockPriceOne" resultType="StockPriceVO">
		select * from stock_info where st_code = #{st_code} order by si_date DESC limit 1
	</select>
	<select id="getCompanyListMrk" resultType="StockVO">
		<![CDATA[  
			SELECT a.*
			FROM stock a
			JOIN (
			    SELECT si.st_code, si.si_mrkTotAmt
			    FROM stock_info si
			    JOIN (
			        SELECT st_code, MAX(si_date) AS latest_date
			        FROM stock_info
			        GROUP BY st_code
			    ) latest ON si.st_code = latest.st_code AND si.si_date = latest.latest_date
			) b ON a.st_code = b.st_code
			where (1)
		]]>
		<if test="cri.st_type != null and cri.st_type.size() > 0 ">
			and a.st_type in
			<foreach collection="cri.st_type" item="items" open="(" close=")" separator=",">
				#{items}
			</foreach>
		</if>
		<if test="cri.mrk != null and cri.mrk.length() > 0 ">
			<choose>
				<when test="cri.mrk == 'small'">
					<![CDATA[  
						and b.si_mrkTotAmt < 300000000000
					]]> 
				</when>
				<when test="cri.mrk == 'medium'">
					<![CDATA[  
						and b.si_mrkTotAmt BETWEEN 300000000000 and 1000000000000
					]]> 
				</when>
				<otherwise>
					<![CDATA[  
						and b.si_mrkTotAmt > 1000000000000
					]]> 
				</otherwise>
			</choose>
		</if>
		order by a.st_name ASC
		<if test="cri != null">
			limit #{cri.pageStart}, #{cri.perPageNum}
		</if>
	</select>
	<select id="getCountMrk" resultType="int">
		<![CDATA[  
			SELECT count(*)
			FROM stock a
			JOIN (
			    SELECT si.st_code, si.si_mrkTotAmt
			    FROM stock_info si
			    JOIN (
			        SELECT st_code, MAX(si_date) AS latest_date
			        FROM stock_info
			        GROUP BY st_code
			    ) latest ON si.st_code = latest.st_code AND si.si_date = latest.latest_date
			) b ON a.st_code = b.st_code
			where (1)
		]]>
		<if test="cri.st_type != null and cri.st_type.size() > 0 ">
			and a.st_type in
			<foreach collection="cri.st_type" item="items" open="(" close=")" separator=",">
				#{items}
			</foreach>
		</if>
		<if test="cri.mrk != null and cri.mrk.length() > 0 ">
			<choose>
				<when test="cri.mrk == 'small'">
					<![CDATA[  
						and b.si_mrkTotAmt < 300000000000
					]]> 
				</when>
				<when test="cri.mrk == 'medium'">
					<![CDATA[  
						and b.si_mrkTotAmt BETWEEN 300000000000 and 1000000000000
					]]> 
				</when>
				<otherwise>
					<![CDATA[  
						and b.si_mrkTotAmt > 1000000000000
					]]> 
				</otherwise>
			</choose>
		</if>
	</select>
	<insert id="wishStockInsert" useGeneratedKeys="true" keyColumn="wi_id">
		insert into wish_stock 
		set	st_code = #{code},
			mb_id = #{mb_id}
	</insert>
	<delete id="wishStockDelete">
		delete from wish_stock where st_code = #{code} and mb_id = #{mb_id}
	</delete>
	<select id="wishCheck" resultType="WishVO">
		select * from wish_stock where st_code = #{code} and mb_id = #{mb_id}
	</select>
	<select id="getStockPriceLater" resultType="StockPriceVO">
		select * from stock_info where st_code = #{code} order by si_date DESC limit 1
	</select>
</mapper>